<% content_for :title do %>
  雷达卫星
<% end %>
<div class="row">
  <ul class="col-xs-10 col-xs-offset-1 tab">
    <li role="presentation" class="col-xs-6 active"><a href="#radar" aria-controls="radar" role="tab" data-toggle="tab"><i class="iconfont icon-leida"></i>雷达回波</a></li>
    <li role="presentation" class="col-xs-6"><a href="#satelli" aria-controls="satelli" role="tab" data-toggle="tab"><i class="iconfont icon-weixing"></i>卫星云图</a></li>  
  </ul>
  
</div>

<div class="row tab-content">
  <div role="tabpanel" class="tab-pane active" id="radar">
    <div class="col-xs-10 col-xs-offset-1 info">
      <div class="col-xs-7 date-time">更新时间: <%= DateTime.now.strftime('%F %H:%M') %></div>
      <div class="col-xs-5 sub-info text-right">红点代表当前位置</div>
    </div>
    <div id="picture-container" class="col-xs-12 container">
      <div id="scroller" class="picture-canvas">
        <img src="<%= image_url @radar_images.first[:url] %>" alt="">
      </div>
    </div>
    <div class="col-xs-12 radar-bitmap">
      <%= image_tag "radar_bitmap.png" %>
    </div>
    <div class="radar-time-line">
      <div class="radar-play">
        <i class="iconfont icon-bofang"></i>
      </div>
      <ul class="time-line">
        <% @radar_images.each_with_index do |item, idx| %>
          <li data-idx="<%=idx%>" class="<%= 'divide' if idx < 5 %> time radar<%=idx%>" data-url="../images/<%= item[:url] %>"><%= item[:datetime].to_datetime.strftime('%H:%M') %></li>
        <% end %>
      </ul>
      <div id="radar-divide">
    </div>
    </div>
  </div>
  <div role="tabpanel" class="tab-pane" id="satelli">
    <div class="col-xs-10 col-xs-offset-1 info">
      <div class="col-xs-7 date-time">更新时间: <%= @cloud_img.first['datetime'].to_datetime.strftime('%F %H:%M') %></div>
    </div>
    <div class="cloud-container">
      <%= image_tag @cloud_img.first['url'] %>
    </div> 
    <div class="cloud-time-line">
      <div class="cloud-play">
        <i class="iconfont icon-bofang"></i>
      </div>
      <ul class="time-line">
        <% @cloud_img[0,6].each_with_index do |item, idx| %>
          <li data-idx="<%=idx%>" class="<%= 'divide' if idx < 5 %> time cloud<%=idx%>" data-url="<%= item['url'] %>"><%= item['datetime'].to_datetime.strftime('%H:%M') %></li>
        <% end %>
      </ul>
      <div id="cloud-divide"></div>
    </div>
  </div>
</div>

<script>
  $(function(){
    var w_width = $(document).width();
    $('.time-line > li').width((w_width - 76) / 6);

    var run_thread;
    $('.cloud-play').on('click', function(){
      var run_btn = $(this).find('i');
      if (run_btn.hasClass('icon-bofang')) {
        $(this).find('i').removeClass('icon-bofang').addClass('icon-zanting');
        var i = 0
        run_thread = setInterval(function() {
          if (i == 0) {
            $('.cloud-time-line').find('li.cloud5').removeClass('active');  
          }
          $('.cloud-time-line').find('li.cloud'+(i-1)).removeClass('active');
          cloud_active(i);
          $('.cloud-time-line').find('li.cloud'+i).addClass('active');
          $('.cloud-container img').attr('src', $('.cloud-time-line').find('li.cloud'+i).attr('data-url'));    
          i++;
          if (i >= 6) {
            i = 0;
          }
        }, 200);
      } else {
        clearInterval(run_thread);
        $(this).find('i').removeClass('icon-zanting').addClass('icon-bofang');
      }
    });

    $('.radar-play').on('click', function(){
      var run_btn = $(this).find('i');
      if (run_btn.hasClass('icon-bofang')) {
        $(this).find('i').removeClass('icon-bofang').addClass('icon-zanting');
        var i = 0
        run_thread = setInterval(function() {
          if (i == 0) {
            $('.radar-time-line').find('li.radar5').removeClass('active');  
          }
          $('.radar-time-line').find('li.radar'+(i-1)).removeClass('active');
          radar_active(i);
          $('.radar-time-line').find('li.radar'+i).addClass('active');
          $('.picture-canvas img').attr('src', $('.radar-time-line').find('li.radar'+i).attr('data-url'));    
          i++;
          if (i >= 6) {
            i = 0;
          }
        }, 200);
      } else {
        clearInterval(run_thread);
        $(this).find('i').removeClass('icon-zanting').addClass('icon-bofang');
      }
    });

    function cloud_active(i) {
      var w = $('.cloud-time-line').find('li').width();
      $('#cloud-divide').css('left', (w * i) + (w / 2) + 40);
    }

    function radar_active(i) {
      var w = $('.radar-time-line').find('li').width();
      $('#radar-divide').css('left', (w * i) + (w / 2) + 40); 
    }

    $('.time-line').on('click', 'li', function(evt){
      cloud_active($(this).attr('data-idx'));
      $('.cloud-container img').attr('src', $(this).attr('data-url'));
    });

    var startX, startY, endX, endY;
    var base_x = -300;
    var base_y = -400;
    $("#scroller").on("touchstart", function(evt){
      var _touch = evt.originalEvent.targetTouches[0];
      startX = _touch.pageX;
      startY = _touch.pageY;
    }).on("touchmove", function(evt){
      var _touch = evt.originalEvent.targetTouches[0];
      endX = _touch.pageX;
      endY = _touch.pageY;
      var _x = base_x + _touch.pageX;
      var _y = base_y + _touch.pageY;
      if (_x > 0) _x = 0;
      if (_x < -410) _x = -410;
      
      if (_y > 0) _y = 0;
      if (_y < -300) _y = -300;
      $(this).css('transform', 'translate('+_x+'px,'+_y+'px)');
    }).on("touchend", function(evt){
      base_x -= (startX - endX);
      base_y -= (startY - endY);
    });

    $("ul.tab").on("click", "li", function(){
      clearInterval(run_thread);
    });
    $(document).on('touchmove', function (e) { e.preventDefault(); }, false);
  });
</script>
