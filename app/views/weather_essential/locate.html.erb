<% content_for :scripts do %>
  <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
  <script>
    // 解决页面返回后，重新载入的问题
    if(sessionStorage.getItem('now_url') === "/weather_essential") {
      sessionStorage.removeItem('now_url');
      <% sign_package = $client.get_jssign_package(request.url) %>
      wx.config({
        debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
        appId: '<%= sign_package['appId'] %>', // 必填，公众号的唯一标识
        timestamp: '<%= sign_package['timestamp'] %>', // 必填，生成签名的时间戳
        nonceStr: '<%= sign_package['nonceStr'] %>', // 必填，生成签名的随机串
        signature: '<%= sign_package['signature'] %>',// 必填，签名，见附录1
        jsApiList: [] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
      });
      wx.ready(function(){
        wx.closeWindow();
      });
    } else {
      var geolocation = new qq.maps.Geolocation("O2KBZ-EILW5-NOJIH-QWO7L-VLF25-QFFDV", "community_disaster_prevent");
      // 获取当前定位
      geolocation.getLocation(showPosition, showErr, options);
      var positionNum = 0;
      var options = {timeout: 80000};
    }

    function showPosition(r) {
      console.log(r);
      if(r.district === '松江区') {
        window.location.href = "../weather_essential?lon="+r.lng+"&lat="+r.lat;
      } else {
        window.location.href = "../weather_essential?lon=121.235323&lat=31.036755";
      }
    };

    function showErr() {
      document.getElementById("map_container").innerHTML = "定位失败！";
    };
  </script>
<% end %>